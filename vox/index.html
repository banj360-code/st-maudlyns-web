<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOX PECATIS | St. Maudlyns-le-Wold</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            background-color: #100a09; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            font-family: 'Old Standard TT', serif;
        }

        .confessional-interface {
            position: relative;
            width: 800px; 
            height: 800px;
            /* SEVERAL ATTEMPTS AT THE PATH - ADJUST THIS TO YOUR FOLDER */
            background: url('vox-pecatis-box.png') no-repeat center center;
            background-size: contain;
            border: 1px solid #1a0f0d; /* A faint guide wire */
        }

        #surprise-guest { position: absolute; z-index: 5; pointer-events: none; }
        #heavenly-chariot { position: absolute; z-index: 20; top: 20 %; pointer-events: none; }

        .alms-box {
            position: absolute;
            top: 229px; 
            left: 49%;
            transform: translateX(-50%);
            width: 600px;
            z-index: 30;
        }

       

        #confession {
            width: 90%;
            height: 100px;
            background: transparent; /* Default state */
            border: none;
            padding: 8px;
            resize: none;
            outline: none;
            text-align: center;
            font-size: 2.0rem;
            font-family: 'Old Standard TT', serif;
            color: transparent; /* Text hidden until typed */
            
            /* Smooth transition for both color and background */
            transition: color 0.4s ease-in-out, background-color 0.3s ease; 
        }

        /* 1. Change background to black when the user clicks/focuses */
        #confession:focus {
            background-color: #000000; 
        }

        /* 2. Make text visible when something is typed */
        #confession:not(:placeholder-shown) {
            color: #d4ccb8; 
        }

        /* 3. When the user types (and the placeholder is hidden) */
        #confession:not(:placeholder-shown) {
            color: #d4ccb8; /* Your visible text color */
        }

        #submit-btn {
            position: absolute;
            top: 170px; 
            left: 53%;
            transform: translateX(-50%);
            /* Remove background, border, and hide text */
            background: transparent;
            color: transparent;
            border: none;
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            padding: 5px 15px;
            cursor: pointer;
            letter-spacing: 1px;
            /* Reset any button default styling */
            appearance: none;
            -webkit-appearance: none;
        }

 #result {
    position: absolute;
    bottom: 50px; /* Shifted slightly to accommodate the new padding */
    left: 50%;
    transform: translateX(-50%);
    width: 80%; 
    white-space: normal; 
    overflow-wrap: break-word;
    text-align: center;
    font-family: 'Crimson Text', serif;
    font-size: 1.4rem; 
    font-style: italic;
    color: #d4ccb8;

    /* --- NEW: The Semi-Transparent Box --- */
    background-color: rgba(10, 5, 5, 0.85); /* Deep, dark brown/black at 85% opacity */
    padding: 15px 25px; /* Gives the text breathing room inside the box */
    border-radius: 8px; /* Soft, rounded corners */
    box-sizing: border-box; /* Keeps the padding from breaking your 80% width */
    border: 1px solid rgba(212, 204, 184, 0.15); /* A very faint border matching the text color */
    box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.7); /* Drops a soft shadow behind it */
}

/* --- NEW: Hide the box when there is no text --- */
#result:empty {
    display: none;
}
    </style>
</head>
<body>

    <img id="surprise-guest" src="../images/trumpets.png" alt="">

    <div id="heavenly-chariot" class="hidden">
        <div id="bishop-rig">
            <img id="bishop-body" src="../images/bishop-body.png" alt="">
            <img id="bishop-jaw" src="../images/bishop-jaw.png" alt="">
        </div>
    </div>

    <main class="confessional-interface">
        
        <div id="censer-anchor">
            <div id="stage-box">
                <div id="scene">
                    <div id="arm-container">
                        <img src="../images/censer-cut.png" alt="Arm">
                        <div id="censer-wrapper">
                            <img src="../images/censer.png" id="burner" alt="Censer">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="smoke-layer"></div>
        <div class="alms-box">
            <form id="confession-form">
                <textarea id="confession" placeholder="" required></textarea>
                <button type="submit" id="submit-btn">[ ‚úù DEPOSIT ]</button>
            </form>
        </div>
        <div id="result" class="result-box"></div>
    </main>

    <script>
    /* ========================================================
       NEW: CENSER & SMOKE KINEMATICS
       (Inserted cleanly above your existing code)
       ======================================================== */
    const scene = document.getElementById('scene');
    const armContainer = document.getElementById('arm-container');
    const censerWrapper = document.getElementById('censer-wrapper');
    const smokeLayer = document.getElementById('smoke-layer');

    const armPivotX = 68.6;
    const armPivotY = 283.2;
    const censerPivotX = 570;
    const censerPivotY = 70;

    const dx1 = censerPivotX - armPivotX;  
    const dy1 = censerPivotY - armPivotY;   

    const holes = [
        { dx: 571 - censerPivotX, dy: 589 - censerPivotY },
        { dx: 623 - censerPivotX, dy: 593 - censerPivotY },
        { dx: 520 - censerPivotX, dy: 588 - censerPivotY }
    ];

    const censerScale = 0.65; // Matches the CSS transform scale

    function getSafeAngle(element) {
        if (!element) return 0;
        const style = window.getComputedStyle(element);
        const matrix = style.getPropertyValue("transform");
        if (!matrix || matrix === 'none') return 0;
        try {
            const values = matrix.split('(')[1].split(')')[0].split(',');
            return Math.atan2(parseFloat(values[1]), parseFloat(values[0])) || 0;
        } catch (e) {
            return 0;
        }
    }

    function getHolePositions() {
        if (!scene) return [];
        const sceneRect = scene.getBoundingClientRect();
        
        const armAngle = getSafeAngle(armContainer);
        const censerAngle = getSafeAngle(censerWrapper);
        const globalCenserAngle = armAngle + censerAngle;

        const startX = sceneRect.left + (armPivotX * censerScale);
        const startY = sceneRect.top + (armPivotY * censerScale);

        const p2x = (dx1 * Math.cos(armAngle) - dy1 * Math.sin(armAngle)) * censerScale;
        const p2y = (dx1 * Math.sin(armAngle) + dy1 * Math.cos(armAngle)) * censerScale;

        return holes.map(hole => {
            const hx = (hole.dx * Math.cos(globalCenserAngle) - hole.dy * Math.sin(globalCenserAngle)) * censerScale;
            const hy = (hole.dx * Math.sin(globalCenserAngle) + hole.dy * Math.cos(globalCenserAngle)) * censerScale;
            return {
                x: startX + p2x + hx,
                y: startY + p2y + hy
            };
        });
    }

    function spawnSmoke(x, y) {
        if (!smokeLayer || smokeLayer.childElementCount > 45) return;
        const smoke = document.createElement('div');
        smoke.className = 'smoke';
        const baseSize = Math.random() * 15 + 15;
        smoke.style.width = baseSize + 'px';
        smoke.style.height = baseSize + 'px';
        const driftX = (Math.random() * 20) - 10; 
        smoke.style.left = (x - baseSize / 2 + driftX) + 'px';
        smoke.style.top = (y - baseSize / 2) + 'px';
        smokeLayer.appendChild(smoke);
        setTimeout(() => smoke.remove(), 3000);
    }

    function handleSmoke() {
        const currentHolePositions = getHolePositions();
        currentHolePositions.forEach(pos => {
            if (Math.random() > 0.7) spawnSmoke(pos.x, pos.y);
        });
        requestAnimationFrame(handleSmoke);
    }
    
    // Start the smoke animation loop immediately
    requestAnimationFrame(handleSmoke);


    /* ========================================================
       ORIGINAL: ALL LOGIC AND COMMENTS PRESERVED 
       AS PER YOUR MANUSCRIPT
       ======================================================== */
    let audioContext;
    let analyser;
    let dataArray;
    let source;
    let animationId;

    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function animateJaw() {
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for(let i = 0; i < dataArray.length; i++) { sum += dataArray[i]; }
        const volume = sum / dataArray.length;
        const sensitivity = 0.1; 
        const maxDrop = 20; 
        const noiseFloor = 5;   
        let movement = (volume - noiseFloor) * sensitivity;
        if (movement < 0) movement = 0;
        if (movement > maxDrop) movement = maxDrop;
        const jaw = document.getElementById("bishop-jaw");
        if (jaw) { jaw.style.transform = `translateY(${movement}px)`; }
        animationId = requestAnimationFrame(animateJaw);
    }

    document.getElementById("confession-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const confessionInput = document.getElementById("confession");
    const confession = confessionInput.value; // We save their words here

    // 1. ADD THIS: Instantly clear the text from the screen
    confessionInput.value = ""; 
    
    // 2. ADD THIS: Remove the cursor so the black background fades away
    confessionInput.blur(); 

    const resultDiv = document.getElementById("result");
    const submitBtn = document.getElementById("submit-btn");
    const chariot = document.getElementById("heavenly-chariot");
    const surpriseGuest = document.getElementById("surprise-guest");

    // ... (the rest of your code continues exactly the same) ...

        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        surpriseGuest.classList.remove("run-theatre");
        void surpriseGuest.offsetWidth; 
        surpriseGuest.classList.add("run-theatre");

        resultDiv.innerText = "The ritual has begun...";
        submitBtn.disabled = true;
        submitBtn.innerText = "Witnessing...";

        try {
            const response = await fetch('/.netlify/functions/the-reverend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ confession })
            });
            const data = await response.json();

            setTimeout(async () => {
                if (response.status === 200) {
                    resultDiv.innerText = data.absolution;
                    const audioBuffer = await audioContext.decodeAudioData(base64ToArrayBuffer(data.audio));
                    source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 64;
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    chariot.classList.remove("hidden");
                    chariot.classList.add("chariot-active");
                    source.start(0);
                    animateJaw();
                    source.onended = () => {
                        cancelAnimationFrame(animationId);
                        document.getElementById("bishop-jaw").style.transform = `translateY(0px)`;
                        submitBtn.disabled = false;
                        submitBtn.innerText = "Seek Absolution";
                    };
                }
            }, 6000); 
        } catch (error) {
            console.error("Error:", error);
            resultDiv.innerText = "The spirits are silent.";
            submitBtn.disabled = false;
            surpriseGuest.classList.remove("run-theatre");
        }
    });
    </script>
</body>
</html>